<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulator Execution - Veelearn</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            background: #1a1a2e;
            color: #eee;
            margin: 0;
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        }

        .execute-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header-bar {
            background: #0f3460;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-bar h1 {
            margin: 0;
            font-size: 1.5em;
        }

        .back-button {
            background: #e94560;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .back-button:hover {
            background: #c93b52;
        }

        .execution-area {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
        }

        .canvas-container {
            background: #16213e;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #533483;
        }

        .canvas-container h2 {
            color: #e94560;
            margin-top: 0;
        }

        #simulatorCanvas {
            background: white;
            width: 100%;
            height: 600px;
            display: block;
            border-radius: 6px;
            border: 1px solid #ddd;
        }

        .controls-panel {
            background: #16213e;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #533483;
            height: fit-content;
        }

        .controls-panel h3 {
            color: #e94560;
            margin-top: 0;
        }

        .control-button {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 0.95em;
        }

        .control-button.play {
            background: #10b981;
            color: white;
        }

        .control-button.play:hover {
            background: #059669;
        }

        .control-button.stop {
            background: #ef4444;
            color: white;
        }

        .control-button.stop:hover {
            background: #dc2626;
        }

        .control-button.reset {
            background: #f59e0b;
            color: white;
        }

        .control-button.reset:hover {
            background: #d97706;
        }

        .info-section {
            margin-top: 20px;
            padding: 15px;
            background: #0f3460;
            border-radius: 6px;
            border-left: 3px solid #667eea;
        }

        .info-section h4 {
            margin: 0 0 10px 0;
            color: #667eea;
        }

        .info-text {
            font-size: 0.9em;
            color: #ccc;
            margin: 5px 0;
        }

        .status {
            padding: 10px;
            margin-top: 10px;
            border-radius: 6px;
            text-align: center;
            font-weight: 600;
        }

        .status.running {
            background: #10b981;
            color: white;
        }

        .status.stopped {
            background: #ef4444;
            color: white;
        }

        .status.ready {
            background: #667eea;
            color: white;
        }

        .error-message {
            background: #dc2626;
            color: white;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }

        .success-message {
            background: #10b981;
            color: white;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="execute-container">
        <div class="header-bar">
            <h1 id="simulatorTitle">Simulator Execution</h1>
            <button class="back-button" onclick="goBack()">← Back</button>
        </div>

        <div id="errorMessage" class="error-message"></div>
        <div id="successMessage" class="success-message"></div>

        <div class="execution-area">
            <div class="canvas-container">
                <h2>Canvas</h2>
                <canvas id="simulatorCanvas" width="800" height="600"></canvas>
            </div>

            <div class="controls-panel">
                <h3>Controls</h3>
                <button class="control-button play" onclick="runSimulator()">▶ Run</button>
                <button class="control-button stop" onclick="stopSimulator()">⏹ Stop</button>
                <button class="control-button reset" onclick="resetSimulator()">⟲ Reset</button>

                <div id="simulatorStatus" class="status ready">READY</div>

                <div class="info-section">
                    <h4>Simulator Info</h4>
                    <div class="info-text" id="creatorInfo">Creator: Unknown</div>
                    <div class="info-text" id="typeInfo">Type: Block-based</div>
                    <div class="info-text" id="dateInfo">Created: Unknown</div>
                </div>

                <div class="info-section">
                    <h4>FPS Monitor</h4>
                    <div class="info-text" id="fpsCounter">FPS: 0</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Libraries -->
    <script src="block-physics-engine.js"></script>
    <script src="block-animation.js"></script>
    <script src="block-renderer-system.js"></script>
    <script src="block-execution-engine.js"></script>
    <script src="block-templates-unified.js"></script>

    <script>
        // Global state
         let simulator = null;
         let simulatorId = null;
         let authToken = localStorage.getItem('token');
         let isRunning = false;
        let animationFrameId = null;
        let canvas = document.getElementById('simulatorCanvas');
        let ctx = canvas.getContext('2d');
        let frameCount = 0;
        let lastFrameTime = Date.now();
        let fps = 0;

        // Get simulator ID from URL parameters
        function getSimulatorId() {
            const params = new URLSearchParams(window.location.search);
            return params.get('id');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            simulatorId = getSimulatorId();
            if (!simulatorId) {
                showError('No simulator ID provided');
                return;
            }
            loadSimulator();
        });

        // Load simulator from backend
        function loadSimulator() {
            if (!authToken) {
                showError('Not authenticated. Please login first.');
                return;
            }

            console.log('Loading simulator ID:', simulatorId);

            fetch(`http://localhost:3000/api/simulators/${simulatorId}`, {
                headers: { 'Authorization': `Bearer ${authToken}` }
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    simulator = data.data;
                    console.log('Simulator loaded:', simulator);
                    
                    document.getElementById('simulatorTitle').textContent = simulator.title || 'Simulator';
                    document.getElementById('creatorInfo').textContent = `Creator: ${simulator.creator_email || 'Unknown'}`;
                    document.getElementById('typeInfo').textContent = `Type: Block-based`;
                    document.getElementById('dateInfo').textContent = `Created: ${new Date(simulator.created_at).toLocaleDateString()}`;
                    
                    // Log blocks and connections
                    console.log('Blocks:', simulator.blocks);
                    console.log('Connections:', simulator.connections);
                    
                    if (!simulator.blocks || simulator.blocks.length === 0) {
                        showSuccess('Simulator loaded (no blocks configured)');
                    } else {
                        showSuccess(`Simulator loaded with ${simulator.blocks.length} blocks`);
                    }
                } else {
                    showError(data.message || 'Failed to load simulator');
                }
            })
            .catch(err => {
                console.error('Error loading simulator:', err);
                showError('Connection error. Make sure backend is running on port 3000');
            });
        }

        // Run simulator
        function runSimulator() {
            if (isRunning) return;
            if (!simulator) {
                showError('Simulator not loaded');
                return;
            }

            try {
                isRunning = true;
                updateStatus('RUNNING', 'running');
                clearCanvas();
                
                // Get blocks from simulator data
                const blocks = simulator.blocks || [];
                const connections = simulator.connections || [];
                
                console.log('Running simulation with', blocks.length, 'blocks');
                
                // Execute blocks
                if (blocks && blocks.length > 0) {
                    console.log('Executing blocks:', blocks);
                    // TODO: Implement block execution engine
                    // For now just show success
                    showSuccess(`Simulation executed: ${blocks.length} blocks processed`);
                } else {
                    showSuccess('Simulator executed (no blocks to run)');
                }
                
                // Animate the simulation
                animateSimulation(blocks);
            } catch (err) {
                console.error('Error running simulator:', err);
                showError('Error executing simulator: ' + err.message);
                isRunning = false;
                updateStatus('ERROR', 'error');
            }
        }

        // Stop simulator
        function stopSimulator() {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            isRunning = false;
            updateStatus('STOPPED', 'stopped');
            clearCanvas();
        }

        // Reset simulator
        function resetSimulator() {
            stopSimulator();
            clearCanvas();
            updateStatus('READY', 'ready');
        }

        // Execute single frame
        function executeSimulationFrame(blocks) {
            // This would use the block execution engine
            // For now, just clear and draw
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw simulator content if it has visualization data
            if (simulator.visualization) {
                drawVisualization(JSON.parse(simulator.visualization));
            }
        }

        // Animate simulation
        function animateSimulation(blocks) {
            const animate = () => {
                const now = Date.now();
                const delta = (now - lastFrameTime) / 1000; // delta in seconds
                lastFrameTime = now;

                frameCount++;
                if (frameCount % 10 === 0) {
                    fps = Math.round(1 / delta);
                    document.getElementById('fpsCounter').textContent = `FPS: ${fps}`;
                }

                if (isRunning) {
                    executeSimulationFrame(blocks);
                    animationFrameId = requestAnimationFrame(animate);
                }
            };

            animationFrameId = requestAnimationFrame(animate);
        }

        // Draw visualization
        function drawVisualization(vizData) {
            if (!vizData) return;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#fff';
            ctx.font = '16px Arial';
            ctx.fillText('Simulator: ' + (simulator.title || 'Unknown'), 20, 40);
            ctx.fillText('Status: Running', 20, 70);
        }

        // Clear canvas
        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#999';
            ctx.font = '14px Arial';
            ctx.fillText('Ready to run', 20, 40);
        }

        // UI Helpers
        function updateStatus(text, className) {
            const status = document.getElementById('simulatorStatus');
            status.textContent = text;
            status.className = 'status ' + className;
        }

        function showError(message) {
            const el = document.getElementById('errorMessage');
            el.textContent = '❌ ' + message;
            el.style.display = 'block';
            setTimeout(() => { el.style.display = 'none'; }, 5000);
            console.error(message);
        }

        function showSuccess(message) {
            const el = document.getElementById('successMessage');
            el.textContent = '✓ ' + message;
            el.style.display = 'block';
            setTimeout(() => { el.style.display = 'none'; }, 3000);
        }

        function goBack() {
            window.history.back();
        }

        // Initial state
        clearCanvas();
        updateStatus('LOADING', 'ready');
    </script>
</body>
</html>
